#!/bin/bash

CURRENT_DIR="$(dirname "${0:-}")"
BUILDPACK_DIR="$(cd "$CURRENT_DIR/.." || exit; pwd)"

# shellcheck source=lib/output.sh
source "$BUILDPACK_DIR/lib/output.sh"

# Taken from https://devcenter.heroku.com/articles/buildpack-api#bin-compile
export_env_dir() {
  env_dir=$1
  bp_dir=${2:-}
  whitelist_regex=${3:-''}
  blacklist_regex=${4:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  if [ -d "$env_dir" ]; then
    for f in "$env_dir"/*; do
      e=$(basename "$f")
      echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
      echo "export $e=$(cat "$env_dir/$e")" >> "$bp_dir/export" &&
      echo "$e variable exported"
      :
    done
  fi
}

# BUILD_DIR="${1:-}"
ENV_DIR="${3:-}"

export_env_dir "$ENV_DIR" "$BUILDPACK_DIR" '^PIP_.*' | indent
